<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LLM Duel Arena ‚Äî v2.9 (Local-file compatible + P2P + Share Link)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <!-- Crypto fallback (works on file://): -->
  <script src="https://cdn.jsdelivr.net/npm/asmcrypto.js@2.3.2/dist/asmcrypto.all.es5.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Inter:wght@400;700;900&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Inter', sans-serif; background:#111827; color:#e5e7eb; }
    .mono { font-family: 'Roboto Mono', monospace; }
    .glass { background: rgba(31,41,55,.55); backdrop-filter: blur(10px); border:1px solid rgba(75,85,99,.5); }
    textarea, input, select { background:#1F2937; border:1px solid #4B5563; color:#E5E7EB; }
    textarea:focus, input:focus, select:focus { outline:none; border-color:#2563EB; box-shadow:0 0 0 2px rgba(37,99,235,.5); }
    .btn { transition: transform .15s ease; }
    .btn:hover { transform: translateY(-1px); }
    .typing-indicator { display:none; }
    .typing-indicator.active { display:block; animation:pulse 1.4s infinite; }
    @keyframes pulse { 0%,100%{opacity:.4} 50%{opacity:1} }
    .badge { font-size:.65rem; padding:.15rem .4rem; border-radius:.375rem; border:1px solid #4B5563; }
    .warn { background:rgba(180,83,9,.15); border:1px solid rgba(180,83,9,.5); }
    .toast { transition: opacity .2s ease; }
  </style>
</head>
<body>
  <main class="container mx-auto p-4 md:p-8">
    <header class="text-center my-6">
      <h1 class="text-5xl font-black text-white mono">LLM DUEL ARENA</h1>
      <p class="text-gray-400">v2.9 ‚Äî HTML-only, password-gated, threaded response stacks ‚Ä¢ <span class="font-semibold">LLM Relay + P2P</span></p>
      <p id="status" class="sr-only" aria-live="polite"></p>
      <div id="secureWarn" class="warn rounded-lg px-4 py-3 mt-4 text-amber-200 hidden">
        üîí Tip: Open via <strong>https</strong> or <strong>localhost</strong> for native WebCrypto. This build includes a safe crypto fallback for <code class="mono">file://</code> too.
      </div>
      <div id="rtcWarn" class="warn rounded-lg px-4 py-3 mt-2 text-amber-200 hidden">
        üåê Note: Some browsers restrict WebRTC on <code class="mono">file://</code>. If P2P can't connect, try the same file on <strong>localhost</strong> (e.g. <code>python -m http.server</code>) or switch to ‚ÄúLLM Relay‚Äù transport.
      </div>
    </header>

    <section class="glass rounded-xl p-6 mb-8" id="connection">
      <h2 class="text-2xl font-bold text-yellow-400 mb-4 border-b border-yellow-500 pb-2">Connection</h2>
      <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
        <div>
          <label class="text-sm">I am</label>
          <select id="player-name" class="w-full p-2.5 rounded">
            <option value="Sister">Sister</option>
            <option value="Salva">Salva</option>
          </select>
        </div>
        <div>
          <label class="text-sm">Room ID</label>
          <input id="room-id" class="w-full p-2.5 rounded mono" placeholder="arena-001" />
        </div>
        <div>
          <label class="text-sm">Room Password</label>
          <div class="flex gap-2">
            <input id="room-pass" type="password" class="w-full p-2.5 rounded" placeholder="shared secret" />
            <button id="toggle-pass" class="btn px-3 rounded bg-gray-700" title="Show/Hide">üëÅ</button>
          </div>
          <p class="text-xs text-gray-400 mt-1">Shared secret ‚Üí AES-GCM key (PBKDF2). Only correct password can read.</p>
        </div>
        <div>
          <label class="text-sm">Transport</label>
          <select id="transport" class="w-full p-2.5 rounded">
            <option value="p2p" selected>P2P (WebRTC, copy/paste)</option>
            <option value="llm">LLM Relay (copy/paste)</option>
            <option value="ls">Same-device (localStorage)</option>
          </select>
          <p class="text-xs text-gray-400 mt-1">Use P2P for cross-device. LLM Relay sends encrypted packets you paste into an LLM chat.</p>
        </div>
        <div class="flex items-end">
          <button id="connect-btn" class="btn bg-green-600 hover:bg-green-500 text-white font-bold py-2.5 px-4 rounded w-full">Join Room</button>
        </div>

        <div class="md:col-span-5">
          <div class="flex flex-wrap items-center gap-3 mt-1">
            <label class="flex items-center gap-2 text-sm">
              <input type="checkbox" id="share-include-pw" class="accent-amber-500">
              Include password in link <span class="text-amber-300">(not recommended)</span>
            </label>
            <button id="share-copy" class="btn bg-sky-600 hover:bg-sky-500 text-white font-bold py-2 px-3 rounded">Copy Share Link</button>
            <button id="share-update-url" class="btn bg-gray-700 hover:bg-gray-600 text-white py-2 px-3 rounded">Update URL</button>
            <span id="share-toast" class="toast text-xs text-gray-400"></span>
          </div>
          <p class="text-xs text-gray-500 mt-1">The link pre-fills using <code class="mono">#room</code>, <code class="mono">#name</code>, <code class="mono">#t</code>, and optionally <code class="mono">#pw</code>. Example: <code class="mono">#/room=arena-001&name=Sister&t=p2p</code></p>
        </div>
      </div>
      <div class="mt-3 text-sm text-gray-300">Fingerprint: <code id="fp" class="mono">‚Äî</code> <span class="text-gray-500">(players compare)</span></div>
    </section>

    <section id="arena" class="hidden relative">
      <div class="glass rounded-xl p-6 mb-6 flex flex-wrap items-center gap-3 justify-between sticky top-0 z-10">
        <div class="flex items-center gap-3 text-sm">
          <span class="inline-block w-3 h-3 rounded-full bg-red-500" id="dot"></span>
          <span>Room: <span id="room-label" class="mono"></span></span>
          <span class="badge">Mode: <span id="mode-badge" class="mono">P2P</span></span>
        </div>
        <div class="flex gap-2">
          <button id="shareTopBtn" class="btn bg-sky-600 hover:bg-sky-500 text-white font-bold py-2 px-4 rounded">Share Link</button>
          <button id="exportPdfBtn" class="btn bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded">Export PDF</button>
          <button id="newDuelBtn" class="btn bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded">New Duel</button>
          <button id="lockBtn" class="btn bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded">Lock Session</button>
          <button id="disconnect-btn" class="btn bg-orange-600 hover:bg-orange-500 text-white font-bold py-2 px-4 rounded">Disconnect</button>
        </div>
      </div>

      <section class="glass rounded-xl p-6 mb-8" id="llm-console" style="display:none">
        <h3 class="text-2xl font-bold text-amber-400 mb-3 border-b-2 border-amber-400 pb-2">LLM Relay Console</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm mb-1">Outbox (share this in LLM chat)</label>
            <textarea id="llm-out" rows="8" class="w-full p-2.5 rounded mono" placeholder="Click Generate Packet to produce ciphertext‚Ä¶"></textarea>
            <div class="mt-2 flex gap-2 text-sm items-center">
              <button id="llm-gen" class="btn bg-amber-600 hover:bg-amber-500 text-white px-3 py-2 rounded">Generate Packet</button>
              <button id="llm-copy" class="btn bg-gray-700 hover:bg-gray-600 text-white px-3 py-2 rounded">Copy</button>
              <span class="text-gray-400">Queued: <span id="llm-q">0</span></span>
            </div>
            <p class="text-xs text-gray-400 mt-2">Paste into an LLM as a code block. Tell it: <em>relay as-is, no edits.</em></p>
          </div>
          <div>
            <label class="block text-sm mb-1">Inbox (paste packet from LLM)</label>
            <textarea id="llm-in" rows="8" class="w-full p-2.5 rounded mono" placeholder="Paste BEGIN/END DUELPACK block here‚Ä¶"></textarea>
            <div class="mt-2 flex gap-2 text-sm">
              <button id="llm-import" class="btn bg-indigo-700 hover:bg-indigo-600 text-white px-3 py-2 rounded">Import Packet</button>
              <button id="llm-clear" class="btn bg-gray-700 hover:bg-gray-600 text-white px-3 py-2 rounded">Clear</button>
              <button id="selftest" class="btn bg-teal-700 hover:bg-teal-600 text-white px-3 py-2 rounded">Run Self-Tests</button>
            </div>
            <p class="text-xs text-gray-400 mt-2">We verify room and fingerprint before decrypting; AES-GCM provides integrity.</p>
          </div>
        </div>
      </section>

      <section class="glass rounded-xl p-6 mb-8" id="p2p-console" style="">
        <h3 class="text-2xl font-bold text-green-400 mb-3 border-b-2 border-green-400 pb-2">P2P Console (WebRTC)</h3>
        <p class="text-sm text-gray-300 mb-3">Use for <span class="font-semibold">live cross-device</span> comms without a server. Copy/paste offer/answer once per session.</p>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm mb-1">Your Offer (create then share)</label>
            <textarea id="rtc-offer" rows="7" class="w-full p-2.5 rounded mono" placeholder="Click Create Offer‚Ä¶"></textarea>
            <div class="mt-2 flex gap-2 text-sm">
              <button id="rtc-create-offer" class="btn bg-green-700 hover:bg-green-600 text-white px-3 py-2 rounded">Create Offer</button>
              <button id="rtc-copy-offer" class="btn bg-gray-700 hover:bg-gray-600 text-white px-3 py-2 rounded">Copy</button>
            </div>
          </div>
          <div>
            <label class="block text-sm mb-1">Remote Offer (paste then create answer)</label>
            <textarea id="rtc-remote-offer" rows="7" class="w-full p-2.5 rounded mono" placeholder="Paste partner's Offer (base64)‚Ä¶"></textarea>
            <div class="mt-2 flex gap-2 text-sm">
              <button id="rtc-make-answer" class="btn bg-indigo-700 hover:bg-indigo-600 text-white px-3 py-2 rounded">Create Answer</button>
              <button id="rtc-copy-answer" class="btn bg-gray-700 hover:bg-gray-600 text-white px-3 py-2 rounded">Copy Answer</button>
            </div>
            <label class="block text-sm mt-4 mb-1">Remote Answer (paste and connect)</label>
            <textarea id="rtc-answer" rows="7" class="w-full p-2.5 rounded mono" placeholder="Paste partner's Answer (base64)‚Ä¶"></textarea>
            <div class="mt-2 flex gap-2 text-sm">
              <button id="rtc-accept-answer" class="btn bg-indigo-700 hover:bg-indigo-600 text-white px-3 py-2 rounded">Accept Answer</button>
              <span class="badge">RTC: <span id="rtc-status" class="mono">disconnected</span></span>
            </div>
          </div>
        </div>
        <p class="text-xs text-gray-400 mt-2">Data is still AES-GCM end-to-end with your room password; WebRTC is transport only.</p>
      </section>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-8" id="battleground">
        <section class="glass rounded-xl p-6">
          <h3 class="text-2xl font-bold text-cyan-400 mb-3 border-b-2 border-cyan-400 pb-2">Sister</h3>
          <label class="block text-sm mb-1">Prompt</label>
          <input id="p1-prompt" class="w-full p-2.5 rounded mono mb-3" placeholder="Enter the shared prompt‚Ä¶" />
          <label class="block text-sm mb-1">LLM Response (composer)</label>
          <textarea id="p1-response" rows="6" class="w-full p-2.5 rounded mono" placeholder="Paste LLM response‚Ä¶"></textarea>
          <div class="mt-3 flex gap-2">
            <button id="p1-post" class="btn bg-amber-600 hover:bg-amber-500 text-white text-sm font-bold px-3 py-2 rounded">Post to Stack</button>
            <button id="p1-clear" class="btn bg-gray-700 hover:bg-gray-600 text-white text-sm px-3 py-2 rounded">Clear</button>
          </div>
          <h4 class="mt-5 text-sm font-semibold text-gray-300">Stack</h4>
          <div id="p1-stack" class="mt-2 space-y-3"></div>
        </section>

        <section class="glass rounded-xl p-6">
          <h3 class="text-2xl font-bold text-pink-400 mb-3 border-b-2 border-pink-400 pb-2">Salva</h3>
          <label class="block text-sm mb-1">Prompt</label>
          <input id="p2-prompt" class="w-full p-2.5 rounded mono mb-3" placeholder="Enter the shared prompt‚Ä¶" />
          <label class="block text-sm mb-1">LLM Response (composer)</label>
          <textarea id="p2-response" rows="6" class="w-full p-2.5 rounded mono" placeholder="Paste LLM response‚Ä¶"></textarea>
          <div class="mt-3 flex gap-2">
            <button id="p2-post" class="btn bg-amber-600 hover:bg-amber-500 text-white text-sm font-bold px-3 py-2 rounded">Post to Stack</button>
            <button id="p2-clear" class="btn bg-gray-700 hover:bg-gray-600 text-white text-sm px-3 py-2 rounded">Clear</button>
          </div>
          <h4 class="mt-5 text-sm font-semibold text-gray-300">Stack</h4>
          <div id="p2-stack" class="mt-2 space-y-3"></div>
        </section>
      </div>

      <section class="glass rounded-xl p-6 mt-8">
        <h3 class="text-2xl font-bold text-purple-400 mb-3 border-b-2 border-purple-400 pb-2">Strategic Communications</h3>
        <div id="chat" class="h-72 overflow-auto bg-gray-900/80 rounded p-3 space-y-2 border border-gray-700">
          <div class="text-center text-gray-500 italic" id="placeholder">Waiting for strategic communications‚Ä¶</div>
        </div>
        <div class="mt-3 flex gap-2">
          <input id="msg" class="flex-1 p-2.5 rounded" placeholder="Type message‚Ä¶ (Enter to send)" disabled />
          <button id="send" class="btn bg-purple-600 hover:bg-purple-500 text-white font-bold py-2 px-4 rounded" disabled>Send</button>
        </div>
        <div id="tip" class="typing-indicator mt-2 text-sm text-gray-400">Someone is typing‚Ä¶</div>
      </section>

      <div id="lock-overlay" class="absolute inset-0 z-10 hidden items-center justify-center rounded-lg">
        <div class="text-center">
          <svg class="mx-auto h-12 w-12 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
          <p class="mt-4 text-xl font-bold">Session Locked</p>
          <button id="unlockBtn" class="mt-4 btn bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded-lg shadow-lg">Unlock</button>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ===== Helpers =====
    function $(id){ return document.getElementById(id); }
    const enc = new TextEncoder();
    const dec = new TextDecoder();

    function isSubtle(){ return !!(window.crypto && window.crypto.subtle); }

    // UX warnings
    var secureWarn = $('secureWarn');
    var rtcWarn = $('rtcWarn');
    if (!window.isSecureContext) secureWarn.classList.remove('hidden');
    if (typeof RTCPeerConnection === 'undefined') rtcWarn.classList.remove('hidden');

    // Clipboard helper with fallback
    function copyText(text){
      if (navigator.clipboard && window.isSecureContext) {
        return navigator.clipboard.writeText(text).catch(function(){ return legacyCopy(text); });
      }
      return legacyCopy(text);
    }
    function legacyCopy(text){
      var ta = document.createElement('textarea');
      ta.value = text; document.body.appendChild(ta);
      ta.select();
      try { document.execCommand('copy'); }
      catch(e){ console.warn('execCommand copy failed', e); }
      document.body.removeChild(ta);
      return Promise.resolve();
    }

    // URL prefill: #room=‚Ä¶&name=‚Ä¶&pw=‚Ä¶&t=p2p
    (function prefillFromURL(){
      var qs = location.hash.startsWith('#') ? location.hash.slice(1) : location.search.slice(1);
      var params = new URLSearchParams(qs);
      if (params.has('room')) $('room-id').value = params.get('room') || '';
      if (params.has('name')) $('player-name').value = params.get('name') || $('player-name').value;
      if (params.has('pw')) $('room-pass').value = params.get('pw') || '';
      if (params.has('t')) $('transport').value = params.get('t');
    })();

    // Share-link helpers
    function baseURL(){ return location.href.split('#')[0].split('?')[0]; }
    function buildShareURL(includePW){
      var params = new URLSearchParams();
      var r = $('room-id').value.trim();
      var n = $('player-name').value || '';
      var t = $('transport').value || 'p2p';
      var pw = $('room-pass').value || '';
      if (r) params.set('room', r);
      if (n) params.set('name', n);
      if (t) params.set('t', t);
      if (includePW && pw) params.set('pw', pw);
      return baseURL() + '#' + params.toString();
    }
    function toast(m){ var el=$('share-toast'); if(!el) return; el.textContent=m; el.style.opacity='1'; setTimeout(function(){ el.style.opacity='0'; }, 2000); }

    // Base64 helpers
    function toB64(obj){ return btoa(JSON.stringify(obj)); }
    function fromB64(b64){ return JSON.parse(atob(b64)); }
    function b64Bytes(u8){ return btoa(String.fromCharCode.apply(null, u8)); }
    function ub64(str){ var bin = atob(str); var u8 = new Uint8Array(bin.length); for (var i=0;i<bin.length;i++) u8[i]=bin.charCodeAt(i); return u8.buffer; }

    // Crypto (Subtle or asmCrypto fallback)
    function sha256Bytes(u8){
      if (isSubtle()) {
        return crypto.subtle.digest('SHA-256', u8).then(function(buf){ return new Uint8Array(buf); });
      } else {
        return Promise.resolve(asmCrypto.SHA256.bytes(u8));
      }
    }
    function hex(u8){ var s=''; for(var i=0;i<u8.length;i++){ s+=u8[i].toString(16).padStart(2,'0'); } return s; }

    function deriveKey(password, saltBytes){
      if (isSubtle()) {
        return crypto.subtle.importKey('raw', enc.encode(password), 'PBKDF2', false, ['deriveKey']).then(function(base){
          return crypto.subtle.deriveKey(
            {name:'PBKDF2', salt:saltBytes, iterations:120000, hash:'SHA-256'},
            base, {name:'AES-GCM', length:256}, false, ['encrypt','decrypt']);
        });
      } else {
        // asmCrypto PBKDF2 -> 32-byte key
        var key = asmCrypto.PBKDF2_HMAC_SHA256.bytes(password, new Uint8Array(saltBytes), 120000, 32);
        return Promise.resolve(key); // Uint8Array
      }
    }
    function makeSaltFromRoom(id){
      return sha256Bytes(enc.encode('room:'+id)).then(function(d){ return d.slice(0,16); });
    }
    function fingerprint(password, salt){
      var passBytes = enc.encode(password);
      var combo = new Uint8Array(passBytes.length + salt.length);
      combo.set(passBytes,0); combo.set(salt, passBytes.length);
      return sha256Bytes(combo).then(function(dig){ return hex(dig).slice(0,16); });
    }
    function escapeHtml(s){
      return (s||'').replace(/[&<>"']/g, function(c){
        return {"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c];
      });
    }
    function encryptObj(obj){
      var iv = crypto.getRandomValues ? crypto.getRandomValues(new Uint8Array(12)) : asmCrypto.getRandomValues(new Uint8Array(12));
      var data = enc.encode(JSON.stringify(obj));
      if (isSubtle()) {
        return crypto.subtle.encrypt({name:'AES-GCM', iv:iv}, state.key, data).then(function(ct){
          return b64Bytes(iv)+'.'+b64Bytes(new Uint8Array(ct));
        });
      } else {
        var keyBytes = state.key; // Uint8Array
        var ct = asmCrypto.AES_GCM.encrypt(data, keyBytes, iv);
        return Promise.resolve(b64Bytes(iv)+'.'+b64Bytes(ct));
      }
    }
    function decryptObj(packet){
      try{
        var parts = (packet||'').split('.');
        var iv = new Uint8Array(ub64(parts[0]));
        var ctbuf = ub64(parts[1]||'');
        if (isSubtle()) {
          return crypto.subtle.decrypt({name:'AES-GCM', iv:iv}, state.key, ctbuf).then(function(pt){
            return JSON.parse(dec.decode(new Uint8Array(pt)));
          }).catch(function(){ return { error:'decrypt-failed' }; });
        } else {
          try{
            var keyBytes = state.key; // Uint8Array
            var pt = asmCrypto.AES_GCM.decrypt(new Uint8Array(ctbuf), keyBytes, iv);
            return Promise.resolve(JSON.parse(dec.decode(pt)));
          }catch(e){
            return Promise.resolve({ error:'decrypt-failed' });
          }
        }
      }catch(e){ return Promise.resolve({ error:'decrypt-failed' }); }
    }

    // ===== UI refs =====
    var playerName = $('player-name');
    var roomId = $('room-id');
    var roomPass = $('room-pass');
    var togglePass = $('toggle-pass');
    var connectBtn = $('connect-btn');
    var fpLabel = $('fp');

    var arena = $('arena');
    var dot = $('dot');
    var roomLabel = $('room-label');
    var chat = $('chat');
    var msg = $('msg');
    var sendBtn = $('send');
    var placeholder = $('placeholder');
    var tip = $('tip');
    var modeBadge = $('mode-badge');

    var p1Prompt = $('p1-prompt');
    var p2Prompt = $('p2-prompt');
    var p1Resp = $('p1-response');
    var p2Resp = $('p2-response');
    var p1Post = $('p1-post');
    var p2Post = $('p2-post');
    var p1Clear = $('p1-clear');
    var p2Clear = $('p2-clear');
    var p1Stack = $('p1-stack');
    var p2Stack = $('p2-stack');

    // ===== State =====
    var state = { me:'', room:'', key:null, salt:null, connected:false, lastTyping:0, side:null, transport:'p2p', queue:[], seq:0, seen:new Set(), seenPacks:new Set() };

    togglePass.onclick = function(){ roomPass.type = roomPass.type==='password' ? 'text' : 'password'; };

    function roomKey(){ return 'llm_duel_'+state.room; }

    function append(text, who){
      if(placeholder) { try{ placeholder.remove(); }catch(e){} }
      var wrap = document.createElement('div');
      var color = (who==='system') ? 'text-amber-300' : (who===state.me ? 'text-indigo-300' : 'text-emerald-300');
      wrap.className = 'p-2 rounded bg-gray-800/80';
      wrap.innerHTML = '<div class="text-xs text-gray-400">'+new Date().toLocaleTimeString()+' ‚Äî <span class="'+color+'">'+escapeHtml(who)+'</span></div><div class="mono whitespace-pre-wrap">'+escapeHtml(text)+'</div>';
      chat.appendChild(wrap); chat.scrollTop = chat.scrollHeight;
    }

    function syncPrompts(val){ p1Prompt.value = val; p2Prompt.value = val; }

    function addResponseCard(item){
      var stack = item.side==='p1' ? p1Stack : p2Stack;
      var card = document.createElement('div');
      card.className = 'glass rounded p-3';
      card.dataset.id = item.id;
      card.innerHTML = ''
        + '<div class="flex justify-between items-center text-xs text-gray-400">'
        +   '<span>'+new Date(item.ts).toLocaleTimeString()+' ‚Äî <span class="text-emerald-300">'+escapeHtml(item.author)+'</span></span>'
        +   '<code class="mono">'+escapeHtml(item.id)+'</code>'
        + '</div>'
        + '<div class="mono whitespace-pre-wrap text-gray-100 mt-1">'+escapeHtml(item.text)+'</div>'
        + '<div class="mt-2 space-x-2">'
        +   '<button class="btn text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded reply-btn">Reply</button>'
        + '</div>'
        + '<div class="mt-2 hidden reply-box">'
        +   '<textarea rows="3" class="w-full p-2 rounded mono" placeholder="Write a reply‚Ä¶"></textarea>'
        +   '<div class="mt-2 flex gap-2">'
        +     '<button class="btn bg-purple-600 hover:bg-purple-500 text-white text-xs px-3 py-1 rounded send-reply">Send Reply</button>'
        +     '<button class="btn bg-gray-700 hover:bg-gray-600 text-white text-xs px-3 py-1 rounded cancel-reply">Cancel</button>'
        +   '</div>'
        + '</div>'
        + '<div class="mt-3 space-y-2 replies"></div>';

      var replyBtn = card.querySelector('.reply-btn');
      var box = card.querySelector('.reply-box');
      var sendReply = card.querySelector('.send-reply');
      var cancelReply = card.querySelector('.cancel-reply');
      replyBtn.onclick = function(){ box.classList.toggle('hidden'); };
      cancelReply.onclick = function(){ box.classList.add('hidden'); };
      sendReply.onclick = function(){
        var ta = box.querySelector('textarea');
        var text = (ta.value||'').trim(); if(!text) return;
        var reply = { parentId:item.id, side:item.side, author: state.me, text:text, ts: Date.now() };
        addReplyCard(reply);
        broadcast('resp_reply', reply);
        ta.value=''; box.classList.add('hidden');
      };

      stack.prepend(card);
    }

    function addReplyCard(reply){
      var stack = reply.side==='p1' ? p1Stack : p2Stack;
      var card = stack.querySelector('[data-id="'+reply.parentId+'"]');
      if(!card) return;
      var replies = card.querySelector('.replies');
      var node = document.createElement('div');
      node.className = 'rounded bg-gray-800/80 p-2';
      node.innerHTML = '<div class="text-xs text-gray-400">'+new Date(reply.ts).toLocaleTimeString()+' ‚Äî <span class="text-indigo-300">'+escapeHtml(reply.author)+'</span></div><div class="mono whitespace-pre-wrap">'+escapeHtml(reply.text)+'</div>';
      replies.appendChild(node);
    }

    function handlePayload(p){
      if(p.type==='chat') append(p.data.text, p.from);
      else if(p.type==='typing') { tip.classList.add('active'); state.lastTyping = Date.now(); }
      else if(p.type==='prompt') syncPrompts(p.data.prompt);
      else if(p.type==='join') append(p.data+' joined the arena', 'system');
      else if(p.type==='leave') append(p.data+' left the arena', 'system');
      else if(p.type==='resp_push') addResponseCard(p.data);
      else if(p.type==='resp_reply') addReplyCard(p.data);
    }

    function updateQueueCount(){ var el = $('llm-q'); if(el) el.textContent = String(state.queue.length||0); }

    function broadcast(type, data){
      var payload = { id: 'm'+Date.now().toString(36)+Math.random().toString(36).slice(2,8), type:type, data:data, from: state.me, ts: Date.now() };
      return encryptObj(payload).then(function(packet){
        if(state.transport === 'ls'){
          localStorage.setItem(roomKey(), packet);
          if(window.duelBC){ window.duelBC.postMessage(packet); }
        } else if(state.transport === 'p2p'){
          try{ if(window.__DUEL_DC && window.__DUEL_DC.readyState==='open'){ window.__DUEL_DC.send(packet); } }catch(_){}
          localStorage.setItem(roomKey(), packet); // mirror for same-device tabs
        } else {
          state.queue.push(payload); updateQueueCount();
        }
      });
    }

    function onStorage(ev){
      if(ev.key !== roomKey()) return;
      decryptObj(ev.newValue || '').then(function(payload){
        if(payload.error) { append('üîí Encrypted message ‚Äî wrong password?', 'system'); return; }
        if(state.seen.has(payload.id)) return; state.seen.add(payload.id);
        if(payload.from === state.me) return;
        handlePayload(payload);
      });
    }

    // Transport selectors
    var transportSel = $('transport');
    var llmConsole = $('llm-console');
    var p2pConsole = $('p2p-console');

    transportSel.addEventListener('change', function(){
      state.transport = transportSel.value;
      llmConsole.style.display = (state.transport === 'llm') ? '' : 'none';
      p2pConsole.style.display = (state.transport === 'p2p') ? '' : 'none';
      $('mode-badge').textContent = (state.transport==='llm') ? 'LLM Relay' : (state.transport==='p2p' ? 'P2P' : 'localStorage');
    });

    $('share-copy').addEventListener('click', function(){
      var include = $('share-include-pw').checked || false;
      var url = buildShareURL(include);
      copyText(url).then(function(){ toast('Link copied'+(include?' (with password)':'')); });
    });
    $('share-update-url').addEventListener('click', function(){
      var include = $('share-include-pw').checked || false;
      var url = buildShareURL(include);
      try { history.replaceState(null, '', url); } catch(e){}
      toast('URL updated');
    });
    $('shareTopBtn').addEventListener('click', function(){
      var include = confirm('Include password in the link? (Not recommended)');
      var url = buildShareURL(!!include);
      copyText(url).then(function(){ append('Share link copied'+(include?' (with password)':''), 'system'); });
    });

    // Connect / Disconnect
    $('connect-btn').addEventListener('click', function(){
      if(!playerName.value || !roomId.value || !roomPass.value){
        alert('Choose role, room ID, and password.');
        return;
      }

      state.me = playerName.value;
      state.side = (state.me === 'Sister') ? 'p1' : 'p2';
      state.room = roomId.value.trim();
      makeSaltFromRoom(state.room).then(function(salt){
        state.salt = salt;
        return deriveKey(roomPass.value, state.salt);
      }).then(function(key){
        state.key = key;
        return fingerprint(roomPass.value, state.salt);
      }).then(function(fp){
        fpLabel.textContent = fp;

        $('connection').classList.add('hidden');
        arena.classList.remove('hidden');
        roomLabel.textContent = state.room;
        dot.classList.replace('bg-red-500','bg-emerald-500');
        msg.disabled = false; sendBtn.disabled = false; state.connected = true;

        var isP1 = state.side==='p1';
        p1Resp.disabled = !isP1; p1Post.disabled = !isP1; p1Prompt.disabled = !isP1;
        p2Resp.disabled = isP1;  p2Post.disabled = isP1;  p2Prompt.disabled = isP1;

        state.transport = transportSel.value;
        llmConsole.style.display = (state.transport==='llm') ? '' : 'none';
        p2pConsole.style.display = (state.transport==='p2p') ? '' : 'none';
        $('mode-badge').textContent = (state.transport==='llm') ? 'LLM Relay' : (state.transport==='p2p' ? 'P2P' : 'localStorage');

        if(window.BroadcastChannel){
          window.duelBC = new BroadcastChannel(roomKey());
          window.duelBC.onmessage = function(ev){
            decryptObj(ev.data || '').then(function(payload){
              if(payload.error) return;
              if(state.seen.has(payload.id)) return; state.seen.add(payload.id);
              if(payload.from === state.me) return;
              handlePayload(payload);
            });
          };
        }
        window.addEventListener('storage', onStorage);
        append('You joined the arena', 'system');
        broadcast('join', state.me);
      });
    });

    $('disconnect-btn').addEventListener('click', function(){
      if(!state.connected) return;
      broadcast('leave', state.me);
      window.removeEventListener('storage', onStorage);
      if(window.duelBC){ try{ window.duelBC.close(); }catch(e){} window.duelBC = null; }
      arena.classList.add('hidden'); $('connection').classList.remove('hidden');
      msg.disabled = true; sendBtn.disabled = true; chat.innerHTML = '<div id="placeholder" class="text-center text-gray-500 italic">Waiting for strategic communications‚Ä¶</div>';
      state.connected = false; dot.classList.replace('bg-emerald-500','bg-red-500');
    });

    $('send').addEventListener('click', function(){
      var text = (msg.value||'').trim(); if(!text || !state.connected) return;
      append(text, state.me);
      broadcast('chat', { text:text });
      msg.value = ''; msg.focus();
    });
    msg.addEventListener('keydown', function(e){
      if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); $('send').click(); }
      else { broadcast('typing', {}); }
    });
    setInterval(function(){ if(Date.now()-state.lastTyping>1500) tip.classList.remove('active'); }, 800);

    function syncAndBroadcast(val){ syncPrompts(val); broadcast('prompt', { prompt:val }); }
    p1Prompt.addEventListener('input', function(e){ syncAndBroadcast(e.target.value); });
    p2Prompt.addEventListener('input', function(e){ syncAndBroadcast(e.target.value); });

    function postResponse(){
      var side = (state.side === 'p1') ? 'p1' : 'p2';
      var src = (side==='p1') ? p1Resp : p2Resp;
      var text = (src.value||'').trim(); if(!text) return;
      var item = { id: 'r'+Date.now().toString(36)+Math.random().toString(36).slice(2,6), side:side, author: state.me, text:text, ts: Date.now() };
      addResponseCard(item);
      broadcast('resp_push', item);
      src.value='';
    }
    p1Post.addEventListener('click', function(){ if(state.side==='p1') postResponse(); });
    p2Post.addEventListener('click', function(){ if(state.side==='p2') postResponse(); });
    p1Clear.addEventListener('click', function(){ p1Resp.value=''; });
    p2Clear.addEventListener('click', function(){ p2Resp.value=''; });

    // Lock / Export / Reset
    var lockBtn = $('lockBtn');
    var unlockBtn = $('unlockBtn');
    var lockOverlay = $('lock-overlay');
    var newDuelBtn = $('newDuelBtn');
    var exportPdfBtn = $('exportPdfBtn');

    var isLocked=false; var sessionPassword=null;
    function doLock(){ if(isLocked) return; var pw = prompt('Set a session lock password:'); if(pw){ isLocked=true; sessionPassword=pw; lockOverlay.classList.remove('hidden'); lockOverlay.classList.add('flex'); lockBtn.textContent='Locked'; } }
    function doUnlock(){ if(!isLocked) return; var ipw = prompt('Enter password to unlock:'); if(ipw===sessionPassword){ isLocked=false; lockOverlay.classList.add('hidden'); lockOverlay.classList.remove('flex'); lockBtn.textContent='Lock Session'; } else alert('Incorrect password.'); }
    function doNewDuel(){ if(confirm('Clear the arena UI (not other tabs)?')){ p1Prompt.value=''; p2Prompt.value=''; p1Resp.value=''; p2Resp.value=''; p1Stack.innerHTML=''; p2Stack.innerHTML=''; chat.innerHTML = '<div id="placeholder" class="text-center text-gray-500 italic">Waiting for strategic communications‚Ä¶</div>'; } }
    async function doExportPdf(){ if(isLocked){ alert('Unlock first.'); return; } exportPdfBtn.textContent='Generating‚Ä¶'; exportPdfBtn.disabled=true; try{ await exportPDF(); } finally{ exportPdfBtn.textContent='Export PDF'; exportPdfBtn.disabled=false; } }

    lockBtn.addEventListener('click', doLock);
    unlockBtn.addEventListener('click', doUnlock);
    newDuelBtn.addEventListener('click', doNewDuel);
    exportPdfBtn.addEventListener('click', doExportPdf);

    function exportPDF(){
      if(typeof html2canvas==='undefined' || typeof window.jspdf==='undefined'){ alert('html2canvas/jsPDF not loaded in this build.'); return; }
      var jsPDF = window.jspdf.jsPDF;
      var target = document.getElementById('arena');
      return html2canvas(target, { backgroundColor:'#111827', scale:2, useCORS:true, windowWidth: target.scrollWidth, windowHeight: target.scrollHeight })
      .then(function(canvas){
        var imgData = canvas.toDataURL('image/png');
        var pdf = new jsPDF('p','pt','a4');
        var pdfW = pdf.internal.pageSize.getWidth();
        var pdfH = pdf.internal.pageSize.getHeight();
        var imgW = pdfW;
        var imgH = canvas.height * (imgW / canvas.width);
        var heightLeft = imgH;
        var position = 0;
        pdf.addImage(imgData, 'PNG', 0, position, imgW, imgH);
        heightLeft -= pdfH;
        while(heightLeft > 0){
          position = heightLeft * -1;
          pdf.addPage();
          pdf.addImage(imgData, 'PNG', 0, position, imgW, imgH);
          heightLeft -= pdfH;
        }
        pdf.save('LLM_Duel_Arena_'+new Date().toISOString().slice(0,10)+'.pdf');
      });
    }

    // LocalStorage polling (helps in sandboxes)
    var __lastPacket = null;
    setInterval(function(){
      if(!state.connected || !state.room) return;
      try{
        var v = localStorage.getItem(roomKey());
        if(v && v!==__lastPacket){
          __lastPacket=v;
          decryptObj(v).then(function(p){
            if(!p.error && p.from!==state.me && !state.seen.has(p.id)){
              state.seen.add(p.id);
              handlePayload(p);
            }
          });
        }
      }catch(_){}
    }, 600);

    setInterval(function(){ var k = 'llm_duel_'+state.room; if(k && state.connected){ localStorage.removeItem(k); } }, 15000);

    // ===== LLM Relay =====
    var llmOut = $('llm-out');
    var llmIn = $('llm-in');
    var llmGen = $('llm-gen');
    var llmCopy = $('llm-copy');
    var llmClear = $('llm-clear');
    var llmQ = $('llm-q');
    var selftestBtn = $('selftest');

    function packEnvelopeString(ciphertext, seq){
      return 'BEGIN DUELPACK v1\nroom='+state.room+'\nfingerprint='+(fpLabel ? fpLabel.textContent : '')+'\nseq='+String(seq)+'\n'+ciphertext+'\nEND DUELPACK';
    }

    if (llmGen) llmGen.addEventListener('click', function(){
      if(state.transport !== 'llm'){ alert('Switch transport to LLM Relay.'); return; }
      if(!state.queue.length){ alert('Queue is empty.'); return; }
      var items = state.queue.splice(0); updateQueueCount();
      var pack = { v:1, room: state.room, sender: state.me, ts: Date.now(), seq: ++state.seq, items: items };
      encryptObj(pack).then(function(ciphertext){
        if(llmOut) llmOut.value = packEnvelopeString(ciphertext, pack.seq);
      });
    });

    if (llmCopy) llmCopy.addEventListener('click', function(){
      if(!llmOut || !llmOut.value) return;
      copyText("```duelpack\n"+llmOut.value+"\n```");
    });

    if (llmClear) llmClear.addEventListener('click', function(){
      if(llmOut) llmOut.value='';
      if(llmIn) llmIn.value='';
    });

    function stripCR(s){ return (s||'').replace(/\r/g,''); }

    var importBtn = $('llm-import');
    if (importBtn) importBtn.addEventListener('click', function(){
      var text = llmIn ? llmIn.value : '';
      if(!text){ alert('Paste a packet first.'); return; }
      text = text.trim();
      if(text.startsWith('```')){
        var firstNL = text.indexOf('\n');
        var lastFence = text.lastIndexOf('```');
        if(firstNL!==-1 && lastFence!==-1){ text = text.slice(firstNL+1, lastFence); }
      }
      var lines = stripCR(text).split('\n');
      var start = lines.indexOf('BEGIN DUELPACK v1');
      var end = lines.lastIndexOf('END DUELPACK');
      if(start===-1 || end===-1 || end<=start+4){ alert('Invalid packet.'); return; }
      function valOf(line){ var p=line.indexOf('='); return p>=0? line.slice(p+1).trim():''; }
      var room = valOf(lines[start+1]||'');
      var fp = valOf(lines[start+2]||'');
      var seq = Number(valOf(lines[start+3]||''));
      var ciphertext = lines.slice(start+4, end).join('\n').trim();
      if(room !== state.room){ alert('Room mismatch.'); return; }
      if((fp||'') !== ((fpLabel && fpLabel.textContent)||'')){ alert('Fingerprint mismatch (wrong password).'); return; }
      decryptObj(ciphertext).then(function(pack){
        if(!pack || !pack.items){ alert('Decrypt failed.'); return; }
        if(state.seenPacks.has(pack.seq)){ append('Duplicate packet ignored', 'system'); return; }
        state.seenPacks.add(pack.seq);
        for(var i=0;i<pack.items.length;i++){ var it=pack.items[i]; if(!state.seen.has(it.id)){ state.seen.add(it.id); handlePayload(it); } }
        append('Imported packet #'+pack.seq+' from '+pack.sender, 'system');
        if(llmIn) llmIn.value='';
      });
    });

    // ===== P2P (WebRTC) =====
    var __DUEL_PC = null;
    var __DUEL_DC = null; window.__DUEL_DC = null;

    var ICE_SERVERS = [{ urls: 'stun:stun.l.google.com:19302' }]; // add TURN here if needed

    function setRTCStatus(s){ var el=$('rtc-status'); if(el) el.textContent = s; }

    function waitIceComplete(pc){
      return new Promise(function(resolve){
        if (pc.iceGatheringState === 'complete') { resolve(); return; }
        pc.onicecandidate = function(event){ if (event.candidate === null) resolve(); };
      });
    }

    function attachDC(dc){
      __DUEL_DC = dc; window.__DUEL_DC = dc;
      dc.binaryType='arraybuffer';
      dc.onopen = function(){ setRTCStatus('connected'); append('P2P channel open', 'system'); broadcast('join', state.me + ' (via P2P)'); };
      dc.onclose = function(){ setRTCStatus('closed'); append('P2P channel closed', 'system'); };
      dc.onerror = function(e){ setRTCStatus('error'); append('P2P channel error', 'system'); console.error(e); };
      dc.onmessage = function(ev){
        var dataStr = (typeof ev.data==='string') ? ev.data : new TextDecoder().decode(ev.data);
        decryptObj(dataStr).then(function(payload){
          if(payload && !payload.error){
            if(!state.seen.has(payload.id)){ state.seen.add(payload.id); handlePayload(payload); }
          } else {
            append('üîí Received message but could not decrypt (check password/fingerprint).', 'system');
          }
        });
      };
    }

    function ensurePC(){
      if(__DUEL_PC) return __DUEL_PC;
      if (typeof RTCPeerConnection === 'undefined') { append('WebRTC not available in this context.', 'system'); return null; }
      var pc = new RTCPeerConnection({ iceServers: ICE_SERVERS });
      pc.onconnectionstatechange = function(){ setRTCStatus(pc.connectionState||'unknown'); };
      pc.ondatachannel = function(ev){ attachDC(ev.channel); };
      __DUEL_PC = pc;
      return pc;
    }

    var rtcOffer = $('rtc-offer');
    var rtcRemoteOffer = $('rtc-remote-offer');
    var rtcAnswer = $('rtc-answer');
    var rtcCreateOffer = $('rtc-create-offer');
    var rtcCopyOffer = $('rtc-copy-offer');
    var rtcMakeAnswer = $('rtc-make-answer');
    var rtcCopyAnswer = $('rtc-copy-answer');
    var rtcAcceptAnswer = $('rtc-accept-answer');

    rtcCreateOffer.addEventListener('click', function(){
      var pc = ensurePC(); if(!pc) return;
      var iceComplete = waitIceComplete(pc);
      attachDC(pc.createDataChannel('duel'));
      pc.createOffer({ offerToReceiveAudio:false, offerToReceiveVideo:false }).then(function(offer){
        return pc.setLocalDescription(offer);
      }).then(function(){ return iceComplete; }).then(function(){
        var b64 = toB64(pc.localDescription);
        rtcOffer.value = b64; setRTCStatus('offer-created');
      }).catch(function(e){ console.error('Offer Creation Error:', e); setRTCStatus('error-offer'); });
    });

    rtcCopyOffer.addEventListener('click', function(){ if(!rtcOffer.value) return; copyText(rtcOffer.value); });

    rtcMakeAnswer.addEventListener('click', function(){
      var val = (rtcRemoteOffer.value || '').trim(); if(!val){ alert('Paste remote Offer first.'); return; }
      var pc = ensurePC(); if(!pc) return;
      var iceComplete = waitIceComplete(pc);
      pc.setRemoteDescription(fromB64(val)).then(function(){
        return pc.createAnswer();
      }).then(function(answer){
        return pc.setLocalDescription(answer);
      }).then(function(){ return iceComplete; }).then(function(){
        rtcAnswer.value = toB64(pc.localDescription);
        setRTCStatus('answer-created');
      }).catch(function(e){ console.error('Answer Creation Error:', e); setRTCStatus('error-answer-create'); });
    });

    rtcCopyAnswer.addEventListener('click', function(){ if(!rtcAnswer.value) return; copyText(rtcAnswer.value); });

    rtcAcceptAnswer.addEventListener('click', function(){
      var val = (rtcAnswer.value || '').trim(); if(!val){ alert('Paste remote Answer first.'); return; }
      var pc = ensurePC(); if(!pc) return;
      pc.setRemoteDescription(fromB64(val)).then(function(){
        setRTCStatus('connecting‚Ä¶');
      }).catch(function(e){ console.error('Accept Answer Error', e); setRTCStatus('error-answer-accept'); });
    });

    // ===== Self-tests =====
    function runSelfTests(){
      var results = [];
      function ok(name, cond){ results.push({name:name, ok: !!cond}); }

      try {
        var sample = 'BEGIN DUELPACK v1\nroom=test\nfingerprint=ffffeeeeaaaa1111\nseq=1\nCIPHERTEXT\nEND DUELPACK';
        ok('Envelope contains BEGIN/END + seq', sample.indexOf('BEGIN DUELPACK v1')>=0 && sample.indexOf('END DUELPACK')>=0 && /\nseq=1\n/.test(sample));
      } catch(e){ ok('Envelope template literal compiles', false); }

      ok('Join with "\\n" produces A\\nB\\nC', ['A','B','C'].join('\n') === 'A\nB\nC');

      var keyReady = !!state.key;
      if(!keyReady){ ok('Encrypt/Decrypt with key (requires connected state)', false); }
      else {
        var obj = { hello:'world', n:42 };
        encryptObj(obj).then(function(ct){
          decryptObj(ct).then(function(pt){
            ok('Encrypt/Decrypt round-trip', pt.hello==='world' && pt.n===42);
            finalize();
          });
        });
        return;
      }
      finalize();

      function finalize(){
        var passCount = results.filter(function(r){ return r.ok; }).length;
        append('Self-tests: '+passCount+'/'+results.length+' passed\n' + results.map(function(r){ return '‚Ä¢ '+(r.ok?'‚úÖ':'‚ùå')+' '+r.name; }).join('\n'), 'system');
      }
    }
    var selfBtn = $('selftest'); if (selfBtn) selfBtn.addEventListener('click', runSelfTests);
  </script>

<script>
// ===== Strict WebRTC shim (no UI) =====
// Configure via URL hash params (example):
//   #turn=turn.example.com:3478?transport=udp&turns=turn.example.com:5349?transport=tcp&u=user&p=pass&stun=stun.l.google.com:19302&policy=relay
(function(){
  function parseHash(){
    const out = { stun: [], turn: [], turns: [], u:'', p:'', policy:'relay' };
    const h = (location.hash||'').replace(/^#/, '');
    if(!h) return out;
    h.split('&').forEach(pair=>{
      const i = pair.indexOf('=');
      const k = decodeURIComponent(i>=0?pair.slice(0,i):pair);
      const v = decodeURIComponent(i>=0?pair.slice(i+1):'');
      if (k === 'stun') out.stun.push(v);
      else if (k === 'turn') out.turn.push(v);
      else if (k === 'turns') out.turns.push(v);
      else if (k === 'u') out.u = v;
      else if (k === 'p') out.p = v;
      else if (k === 'policy') out.policy = v;
    });
    return out;
  }
  function buildServers(){
    const hp = parseHash();
    const stun = hp.stun.length ? hp.stun.map(u => u.startsWith('stun:')?u:'stun:'+u)
                                 : ['stun:stun.l.google.com:19302','stun:global.stun.twilio.com:3478'];
    const turn = hp.turn.map(u => u.startsWith('turn:')?u:'turn:'+u);
    const turns = hp.turns.map(u => u.startsWith('turns:')?u:'turns:'+u);
    const username = hp.u || undefined;
    const credential = hp.p || undefined;
    const servers = [];
    stun.forEach(s => servers.push({ urls: s }));
    turn.concat(turns).forEach(t => {
      if (username && credential) servers.push({ urls: t, username, credential });
      else servers.push({ urls: t });
    });
    return { servers, policy: 'all' };
  }

  const cfg = buildServers();
  // Expose for debugging
  window.ARENA_RTC_CONFIG = {
    iceServers: cfg.servers,
    iceTransportPolicy: cfg.policy,
    bundlePolicy: 'max-bundle',
    rtcpMuxPolicy: 'require',
    iceCandidatePoolSize: 1
  };

  // Shim RTCPeerConnection to ensure robust defaults without breaking caller configs
  const NativePC = window.RTCPeerConnection || window.webkitRTCPeerConnection || window.mozRTCPeerConnection;
  if (!NativePC) return;

  function mergeServers(a, b){
    // put our servers first so TURN is tried early; keep uniques by urls+username
    const key = s => (Array.isArray(s.urls)?s.urls.join(','):s.urls)+'|'+(s.username||'');
    const map = new Map();
    (a||[]).forEach(s => map.set(key(s), s));
    (b||[]).forEach(s => map.set(key(s), s));
    return Array.from(map.values());
  }

  function withDefaults(user){
    const base = Object.assign({}, window.ARENA_RTC_CONFIG);
    const out = Object.assign({}, base, user||{});
    out.iceServers = mergeServers(base.iceServers, (user&&user.iceServers)||[]);
    // Default to relay policy unless explicitly overridden
    out.iceTransportPolicy = (user && user.iceTransportPolicy) ? user.iceTransportPolicy : base.iceTransportPolicy;
    return out;
  }

  const Patched = function(config){
    const finalCfg = withDefaults(config);
    const pc = new NativePC(finalCfg);
    // Minimal logging to help diagnose "white screen" issues
    try{
      pc.oniceconnectionstatechange = () => console.log('[ICE]', pc.iceConnectionState);
      pc.onicegatheringstatechange = () => console.log('[ICE gather]', pc.iceGatheringState);
      pc.onconnectionstatechange = () => console.log('[PC]', pc.connectionState);
      pc.onicecandidateerror = (e) => console.warn('[ICE error]', e && (e.errorText||e.error||e.message), e && (e.url||''), e && (e.address||''), e && (e.port||''));
    }catch(e){}
    return pc;
  };
  Patched.prototype = NativePC.prototype;
  window.RTCPeerConnection = Patched;

  console.log('[StrictShim] Active with config:', window.ARENA_RTC_CONFIG);
})();
</script>
</body>
</html>
