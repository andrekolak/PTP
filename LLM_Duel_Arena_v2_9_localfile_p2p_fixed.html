<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LLM DUEL ARENA ‚Äî v3.0 (Fire-Proof Relay)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/asmcrypto.js@2.3.2/dist/asmcrypto.all.es5.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Inter:wght@400;700;900&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Inter', sans-serif; background:#111827; color:#e5e7eb; }
    .mono { font-family: 'Roboto Mono', monospace; }
    .glass { background: rgba(31,41,55,.55); backdrop-filter: blur(10px); border:1px solid rgba(75,85,99,.5); }
    textarea, input, select { background:#1F2937; border:1px solid #4B5563; color:#E5E7EB; }
    textarea:focus, input:focus, select:focus { outline:none; border-color:#2563EB; box-shadow:0 0 0 2px rgba(37,99,235,.5); }
    .btn { transition: transform .15s ease; }
    .btn:hover { transform: translateY(-1px); }
    .badge { font-size:.65rem; padding:.15rem .4rem; border-radius:.375rem; border:1px solid #4B5563; }
    .warn { background:rgba(180,83,9,.15); border:1px solid rgba(180,83,9,.5); }
  </style>
</head>
<body>
  <main class="container mx-auto p-4 md:p-8">
    <header class="text-center my-6">
      <h1 class="text-5xl font-black text-white mono">LLM DUEL ARENA</h1>
      <p class="text-gray-400">v3.0 ‚Äî The Fire-Proof Relay Edition (LLM Relay Forced)</p>
      <p id="status" class="sr-only" aria-live="polite"></p>
    </header>

    <section class="glass rounded-xl p-6 mb-8" id="connection">
      <h2 class="text-2xl font-bold text-yellow-400 mb-4 border-b border-yellow-500 pb-2">Connection & Security</h2>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
          <label class="text-sm">I am</label>
          <select id="player-name" class="w-full p-2.5 rounded">
            <option value="Sister">Sister</option>
            <option value="Salva">Salva</option>
          </select>
        </div>
        <div>
          <label class="text-sm">Room ID</label>
          <input id="room-id" class="w-full p-2.5 rounded mono" placeholder="arena-001" />
        </div>
        <div>
          <label class="text-sm">Room Password</label>
          <div class="flex gap-2">
            <input id="room-pass" type="password" class="w-full p-2.5 rounded" placeholder="shared secret" />
            <button id="toggle-pass" class="btn px-3 rounded bg-gray-700" title="Show/Hide">üëÅ</button>
          </div>
          <p class="text-xs text-gray-400 mt-1">Shared secret ‚Üí AES-GCM key. Only correct password can read.</p>
        </div>
        <div class="flex items-end">
          <button id="connect-btn" class="btn bg-green-600 hover:bg-green-500 text-white font-bold py-2.5 px-4 rounded w-full">Join Room</button>
        </div>
      </div>
      <div class="mt-3 text-sm text-gray-300">Fingerprint: <code id="fp" class="mono">‚Äî</code> <span class="text-gray-500">(players compare)</span></div>
      <div class="warn rounded-lg px-4 py-3 mt-4 text-amber-200">
        üåê Mode: **LLM Relay Forced**. **P2P mode disabled** due to unreliable free TURN servers. All data is transferred by Copy/Paste.
      </div>
    </section>

    <section id="arena" class="hidden relative">
      <div class="glass rounded-xl p-6 mb-6 flex flex-wrap items-center gap-3 justify-between sticky top-0 z-10">
        <div class="flex items-center gap-3 text-sm">
          <span>Room: <span id="room-label" class="mono"></span></span>
          <span class="badge">Mode: <span class="mono font-bold text-amber-400">LLM RELAY</span></span>
        </div>
        <div class="flex gap-2">
          <button id="newDuelBtn" class="btn bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded">New Duel</button>
          <button id="disconnect-btn" class="btn bg-orange-600 hover:bg-orange-500 text-white font-bold py-2 px-4 rounded">Disconnect</button>
        </div>
      </div>

      <section class="glass rounded-xl p-6 mb-8" id="llm-console">
        <h3 class="text-2xl font-bold text-amber-400 mb-3 border-b-2 border-amber-400 pb-2">LLM Relay Console (Your Data Transport)</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm mb-1">Outbox ‚Äî To Send to Partner (Queued: <span id="llm-q" class="font-bold">0</span>)</label>
            <textarea id="llm-out" rows="8" class="w-full p-2.5 rounded mono" placeholder="Click GENERATE PACKET to produce the ciphertext‚Ä¶"></textarea>
            <div class="mt-2 flex gap-2 text-sm items-center">
              <button id="llm-gen" class="btn bg-amber-600 hover:bg-amber-500 text-white px-3 py-2 rounded font-bold">1. GENERATE PACKET</button>
              <button id="llm-copy" class="btn bg-gray-700 hover:bg-gray-600 text-white px-3 py-2 rounded">2. Copy Packet</button>
            </div>
            <p class="text-xs text-gray-400 mt-2">After generating, copy the text and send it to your partner using any chat or messaging app.</p>
          </div>
          <div>
            <label class="block text-sm mb-1">Inbox ‚Äî Paste Partner's Packet Here</label>
            <textarea id="llm-in" rows="8" class="w-full p-2.5 rounded mono" placeholder="Paste BEGIN/END DUELPACK block here‚Ä¶"></textarea>
            <div class="mt-2 flex gap-2 text-sm">
              <button id="llm-import" class="btn bg-indigo-700 hover:bg-indigo-600 text-white px-3 py-2 rounded font-bold">3. IMPORT PACKET</button>
              <button id="llm-clear" class="btn bg-gray-700 hover:bg-gray-600 text-white px-3 py-2 rounded">Clear</button>
            </div>
            <p class="text-xs text-gray-400 mt-2">The packet is verified by Room ID and Fingerprint before decrypting.</p>
          </div>
        </div>
      </section>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-8" id="battleground">
        <section class="glass rounded-xl p-6">
          <h3 class="text-2xl font-bold text-cyan-400 mb-3 border-b-2 border-cyan-400 pb-2">Sister (P1)</h3>
          <label class="block text-sm mb-1">Prompt</label>
          <input id="p1-prompt" class="w-full p-2.5 rounded mono mb-3" placeholder="Enter the shared prompt‚Ä¶" />
          <label class="block text-sm mb-1">LLM Response (composer)</label>
          <textarea id="p1-response" rows="6" class="w-full p-2.5 rounded mono" placeholder="Paste LLM response‚Ä¶"></textarea>
          <div class="mt-3 flex gap-2">
            <button id="p1-post" class="btn bg-amber-600 hover:bg-amber-500 text-white text-sm font-bold px-3 py-2 rounded">Post to Stack</button>
            <button id="p1-clear" class="btn bg-gray-700 hover:bg-gray-600 text-white text-sm px-3 py-2 rounded">Clear</button>
          </div>
          <h4 class="mt-5 text-sm font-semibold text-gray-300">Stack</h4>
          <div id="p1-stack" class="mt-2 space-y-3"></div>
        </section>

        <section class="glass rounded-xl p-6">
          <h3 class="text-2xl font-bold text-pink-400 mb-3 border-b-2 border-pink-400 pb-2">Salva (P2)</h3>
          <label class="block text-sm mb-1">Prompt</label>
          <input id="p2-prompt" class="w-full p-2.5 rounded mono mb-3" placeholder="Enter the shared prompt‚Ä¶" />
          <label class="block text-sm mb-1">LLM Response (composer)</label>
          <textarea id="p2-response" rows="6" class="w-full p-2.5 rounded mono" placeholder="Paste LLM response‚Ä¶"></textarea>
          <div class="mt-3 flex gap-2">
            <button id="p2-post" class="btn bg-amber-600 hover:bg-amber-500 text-white text-sm font-bold px-3 py-2 rounded">Post to Stack</button>
            <button id="p2-clear" class="btn bg-gray-700 hover:bg-gray-600 text-white text-sm px-3 py-2 rounded">Clear</button>
          </div>
          <h4 class="mt-5 text-sm font-semibold text-gray-300">Stack</h4>
          <div id="p2-stack" class="mt-2 space-y-3"></div>
        </section>
      </div>

      <section class="glass rounded-xl p-6 mt-8">
        <h3 class="text-2xl font-bold text-purple-400 mb-3 border-b-2 border-purple-400 pb-2">Strategic Communications (Chat)</h3>
        <div id="chat" class="h-72 overflow-auto bg-gray-900/80 rounded p-3 space-y-2 border border-gray-700">
          <div class="text-center text-gray-500 italic" id="placeholder">Waiting for strategic communications‚Ä¶</div>
        </div>
        <div class="mt-3 flex gap-2">
          <input id="msg" class="flex-1 p-2.5 rounded" placeholder="Type message‚Ä¶ (Enter to queue)" disabled />
          <button id="send" class="btn bg-purple-600 hover:bg-purple-500 text-white font-bold py-2 px-4 rounded" disabled>Queue Chat</button>
        </div>
      </section>
    </section>
  </main>

  <script>
    // ** v3.0 FIX: Stripped down to only LLM Relay functionality. **

    // ===== Helpers =====
    function $(id){ return document.getElementById(id); }
    const enc = new TextEncoder();
    const dec = new TextDecoder();

    function isSubtle(){ return !!(window.crypto && window.crypto.subtle); }
    
    function copyText(text){
      if (navigator.clipboard && window.isSecureContext) {
        return navigator.clipboard.writeText(text).catch(function(){ return legacyCopy(text); });
      }
      return legacyCopy(text);
    }
    function legacyCopy(text){
      var ta = document.createElement('textarea');
      ta.value = text; document.body.appendChild(ta);
      ta.select();
      try { document.execCommand('copy'); }
      catch(e){ console.warn('execCommand copy failed', e); }
      document.body.removeChild(ta);
      return Promise.resolve();
    }

    function toB64(obj){ return btoa(JSON.stringify(obj)); }
    function fromB64(b64){ return JSON.parse(atob(b64)); }
    function b64Bytes(u8){ return btoa(String.fromCharCode.apply(null, u8)); }
    function ub64(str){ var bin = atob(str); var u8 = new Uint8Array(bin.length); for (var i=0;i<bin.length;i++) u8[i]=bin.charCodeAt(i); return u8.buffer; }

    function sha256Bytes(u8){
      if (isSubtle()) {
        return crypto.subtle.digest('SHA-256', u8).then(function(buf){ return new Uint8Array(buf); });
      } else {
        // asmCrypto fallback for file://
        return Promise.resolve(asmCrypto.SHA256.bytes(u8));
      }
    }
    function hex(u8){ var s=''; for(var i=0;i<u8.length;i++){ s+=u8[i].toString(16).padStart(2,'0'); } return s; }

    function deriveKey(password, saltBytes){
      if (isSubtle()) {
        return crypto.subtle.importKey('raw', enc.encode(password), 'PBKDF2', false, ['deriveKey']).then(function(base){
          return crypto.subtle.deriveKey(
            {name:'PBKDF2', salt:saltBytes, iterations:120000, hash:'SHA-256'},
            base, {name:'AES-GCM', length:256}, false, ['encrypt','decrypt']);
        });
      } else {
        var key = asmCrypto.PBKDF2_HMAC_SHA256.bytes(password, new Uint8Array(saltBytes), 120000, 32);
        return Promise.resolve(key); // Uint8Array
      }
    }
    function makeSaltFromRoom(id){
      return sha256Bytes(enc.encode('room:'+id)).then(function(d){ return d.slice(0,16); });
    }
    function fingerprint(password, salt){
      var passBytes = enc.encode(password);
      var combo = new Uint8Array(passBytes.length + salt.length);
      combo.set(passBytes,0); combo.set(salt, passBytes.length);
      return sha256Bytes(combo).then(function(dig){ return hex(dig).slice(0,16); });
    }
    function escapeHtml(s){
      return (s||'').replace(/[&<>"']/g, function(c){
        return {"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c];
      });
    }
    function encryptObj(obj){
      var iv = crypto.getRandomValues ? crypto.getRandomValues(new Uint8Array(12)) : asmCrypto.getRandomValues(new Uint8Array(12));
      var data = enc.encode(JSON.stringify(obj));
      if (isSubtle()) {
        return crypto.subtle.encrypt({name:'AES-GCM', iv:iv}, state.key, data).then(function(ct){
          return b64Bytes(iv)+'.'+b64Bytes(new Uint8Array(ct));
        });
      } else {
        var keyBytes = state.key; // Uint8Array
        var ct = asmCrypto.AES_GCM.encrypt(data, keyBytes, iv);
        return Promise.resolve(b64Bytes(iv)+'.'+b64Bytes(ct));
      }
    }
    function decryptObj(packet){
      try{
        var parts = (packet||'').split('.');
        var iv = new Uint8Array(ub64(parts[0]));
        var ctbuf = ub64(parts[1]||'');
        if (isSubtle()) {
          return crypto.subtle.decrypt({name:'AES-GCM', iv:iv}, state.key, ctbuf).then(function(pt){
            return JSON.parse(dec.decode(new Uint8Array(pt)));
          }).catch(function(){ return { error:'decrypt-failed' }; });
        } else {
          try{
            var keyBytes = state.key; // Uint8Array
            var pt = asmCrypto.AES_GCM.decrypt(new Uint8Array(ctbuf), keyBytes, iv);
            return Promise.resolve(JSON.parse(dec.decode(pt)));
          }catch(e){
            return Promise.resolve({ error:'decrypt-failed' });
          }
        }
      }catch(e){ return Promise.resolve({ error:'decrypt-failed' }); }
    }

    // ===== UI refs =====
    var playerName = $('player-name');
    var roomId = $('room-id');
    var roomPass = $('room-pass');
    var togglePass = $('toggle-pass');
    var connectBtn = $('connect-btn');
    var fpLabel = $('fp');

    var arena = $('arena');
    var roomLabel = $('room-label');
    var chat = $('chat');
    var msg = $('msg');
    var sendBtn = $('send');
    var placeholder = $('placeholder');

    var p1Prompt = $('p1-prompt');
    var p2Prompt = $('p2-prompt');
    var p1Resp = $('p1-response');
    var p2Resp = $('p2-response');
    var p1Post = $('p1-post');
    var p2Post = $('p2-post');
    var p1Clear = $('p1-clear');
    var p2Clear = $('p2-clear');
    var p1Stack = $('p1-stack');
    var p2Stack = $('p2-stack');

    var llmOut = $('llm-out');
    var llmIn = $('llm-in');
    var llmGen = $('llm-gen');
    var llmCopy = $('llm-copy');
    var llmClear = $('llm-clear');
    var llmQ = $('llm-q');

    // ===== State =====
    var state = { me:'', room:'', key:null, salt:null, connected:false, side:null, queue:[], seq:0, seen:new Set(), seenPacks:new Set() };

    togglePass.onclick = function(){ roomPass.type = roomPass.type==='password' ? 'text' : 'password'; };

    function append(text, who){
      if(placeholder) { try{ placeholder.remove(); }catch(e){} }
      var wrap = document.createElement('div');
      var color = (who==='system') ? 'text-amber-300' : (who===state.me ? 'text-indigo-300' : 'text-emerald-300');
      wrap.className = 'p-2 rounded bg-gray-800/80';
      wrap.innerHTML = '<div class="text-xs text-gray-400">'+new Date().toLocaleTimeString()+' ‚Äî <span class="'+color+'">'+escapeHtml(who)+'</span></div><div class="mono whitespace-pre-wrap">'+escapeHtml(text)+'</div>';
      chat.appendChild(wrap); chat.scrollTop = chat.scrollHeight;
    }

    function syncPrompts(val){ p1Prompt.value = val; p2Prompt.value = val; }

    function addResponseCard(item){
      var stack = item.side==='p1' ? p1Stack : p2Stack;
      var card = document.createElement('div');
      card.className = 'glass rounded p-3';
      card.dataset.id = item.id;
      card.innerHTML = ''
        + '<div class="flex justify-between items-center text-xs text-gray-400">'
        +   '<span>'+new Date(item.ts).toLocaleTimeString()+' ‚Äî <span class="text-emerald-300">'+escapeHtml(item.author)+'</span></span>'
        +   '<code class="mono">'+escapeHtml(item.id)+'</code>'
        + '</div>'
        + '<div class="mono whitespace-pre-wrap text-gray-100 mt-1">'+escapeHtml(item.text)+'</div>'
        + '<div class="mt-2 space-x-2">'
        +   '<button class="btn text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded reply-btn">Reply</button>'
        + '</div>'
        + '<div class="mt-2 hidden reply-box">'
        +   '<textarea rows="3" class="w-full p-2 rounded mono" placeholder="Write a reply‚Ä¶"></textarea>'
        +   '<div class="mt-2 flex gap-2">'
        +     '<button class="btn bg-purple-600 hover:bg-purple-500 text-white text-xs px-3 py-1 rounded send-reply">Queue Reply</button>'
        +     '<button class="btn bg-gray-700 hover:bg-gray-600 text-white text-xs px-3 py-1 rounded cancel-reply">Cancel</button>'
        +   '</div>'
        + '</div>'
        + '<div class="mt-3 space-y-2 replies"></div>';

      var replyBtn = card.querySelector('.reply-btn');
      var box = card.querySelector('.reply-box');
      var sendReply = card.querySelector('.send-reply');
      var cancelReply = card.querySelector('.cancel-reply');
      replyBtn.onclick = function(){ box.classList.toggle('hidden'); };
      cancelReply.onclick = function(){ box.classList.add('hidden'); };
      sendReply.onclick = function(){
        var ta = box.querySelector('textarea');
        var text = (ta.value||'').trim(); if(!text) return;
        var reply = { parentId:item.id, side:item.side, author: state.me, text:text, ts: Date.now() };
        addReplyCard(reply);
        broadcast('resp_reply', reply);
        ta.value=''; box.classList.add('hidden');
      };

      stack.prepend(card);
    }

    function addReplyCard(reply){
      var stack = reply.side==='p1' ? p1Stack : p2Stack;
      var card = stack.querySelector('[data-id="'+reply.parentId+'"]');
      if(!card) return;
      var replies = card.querySelector('.replies');
      var node = document.createElement('div');
      node.className = 'rounded bg-gray-800/80 p-2';
      node.innerHTML = '<div class="text-xs text-gray-400">'+new Date(reply.ts).toLocaleTimeString()+' ‚Äî <span class="text-indigo-300">'+escapeHtml(reply.author)+'</span></div><div class="mono whitespace-pre-wrap">'+escapeHtml(reply.text)+'</div>';
      replies.appendChild(node);
    }

    function handlePayload(p){
      if(p.type==='chat') append(p.data.text, p.from);
      else if(p.type==='prompt') syncPrompts(p.data.prompt);
      else if(p.type==='join') append(p.data+' joined the arena', 'system');
      else if(p.type==='resp_push') addResponseCard(p.data);
      else if(p.type==='resp_reply') addReplyCard(p.data);
    }

    function updateQueueCount(){ if(llmQ) llmQ.textContent = String(state.queue.length||0); }

    function broadcast(type, data){
      var payload = { id: 'm'+Date.now().toString(36)+Math.random().toString(36).slice(2,8), type:type, data:data, from: state.me, ts: Date.now() };
      // All payloads are queued for the LLM Relay transport.
      state.queue.push(payload); 
      updateQueueCount();
      return Promise.resolve();
    }

    // Connect / Disconnect
    $('connect-btn').addEventListener('click', function(){
      if(!playerName.value || !roomId.value || !roomPass.value){
        alert('Choose role, room ID, and password.');
        return;
      }

      state.me = playerName.value;
      state.side = (state.me === 'Sister') ? 'p1' : 'p2';
      state.room = roomId.value.trim();
      makeSaltFromRoom(state.room).then(function(salt){
        state.salt = salt;
        return deriveKey(roomPass.value, state.salt);
      }).then(function(key){
        state.key = key;
        return fingerprint(roomPass.value, state.salt);
      }).then(function(fp){
        fpLabel.textContent = fp;

        $('connection').classList.add('hidden');
        arena.classList.remove('hidden');
        roomLabel.textContent = state.room;
        msg.disabled = false; sendBtn.disabled = false; state.connected = true;

        var isP1 = state.side==='p1';
        p1Resp.disabled = !isP1; p1Post.disabled = !isP1; p1Prompt.disabled = !isP1;
        p2Resp.disabled = isP1;  p2Post.disabled = isP1;  p2Prompt.disabled = isP1;

        append('You joined the arena', 'system');
        broadcast('join', state.me);
      });
    });

    $('disconnect-btn').addEventListener('click', function(){
      if(!state.connected) return;
      broadcast('leave', state.me);
      arena.classList.add('hidden'); $('connection').classList.remove('hidden');
      msg.disabled = true; sendBtn.disabled = true; chat.innerHTML = '<div id="placeholder" class="text-center text-gray-500 italic">Waiting for strategic communications‚Ä¶</div>';
      state.connected = false; 
    });

    $('send').addEventListener('click', function(){
      var text = (msg.value||'').trim(); if(!text || !state.connected) return;
      append(text, state.me);
      broadcast('chat', { text:text });
      msg.value = ''; msg.focus();
    });
    msg.addEventListener('keydown', function(e){
      if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); $('send').click(); }
    });

    function syncAndBroadcast(val){ syncPrompts(val); broadcast('prompt', { prompt:val }); }
    p1Prompt.addEventListener('input', function(e){ if(state.side==='p1') syncAndBroadcast(e.target.value); });
    p2Prompt.addEventListener('input', function(e){ if(state.side==='p2') syncAndBroadcast(e.target.value); });

    function postResponse(){
      var side = (state.side === 'p1') ? 'p1' : 'p2';
      var src = (side==='p1') ? p1Resp : p2Resp;
      var text = (src.value||'').trim(); if(!text) return;
      var item = { id: 'r'+Date.now().toString(36)+Math.random().toString(36).slice(2,6), side:side, author: state.me, text:text, ts: Date.now() };
      addResponseCard(item);
      broadcast('resp_push', item);
      src.value='';
    }
    p1Post.addEventListener('click', function(){ if(state.side==='p1') postResponse(); });
    p2Post.addEventListener('click', function(){ if(state.side==='p2') postResponse(); });
    p1Clear.addEventListener('click', function(){ p1Resp.value=''; });
    p2Clear.addEventListener('click', function(){ p2Resp.value=''; });

    // Reset
    function doNewDuel(){ if(confirm('Clear the arena UI?')){ p1Prompt.value=''; p2Prompt.value=''; p1Resp.value=''; p2Resp.value=''; p1Stack.innerHTML=''; p2Stack.innerHTML=''; chat.innerHTML = '<div id="placeholder" class="text-center text-gray-500 italic">Waiting for strategic communications‚Ä¶</div>'; } }
    $('newDuelBtn').addEventListener('click', doNewDuel);
    
    // ===== LLM Relay Logic =====
    function packEnvelopeString(ciphertext, seq){
      return 'BEGIN DUELPACK v1\nroom='+state.room+'\nfingerprint='+(fpLabel ? fpLabel.textContent : '')+'\nseq='+String(seq)+'\n'+ciphertext+'\nEND DUELPACK';
    }

    if (llmGen) llmGen.addEventListener('click', function(){
      if(!state.queue.length){ alert('Queue is empty. Post a response or chat message first.'); return; }
      var items = state.queue.splice(0); updateQueueCount();
      var pack = { v:1, room: state.room, sender: state.me, ts: Date.now(), seq: ++state.seq, items: items };
      encryptObj(pack).then(function(ciphertext){
        if(llmOut) llmOut.value = packEnvelopeString(ciphertext, pack.seq);
      });
    });

    if (llmCopy) llmCopy.addEventListener('click', function(){
      if(!llmOut || !llmOut.value) return;
      copyText("```duelpack\n"+llmOut.value+"\n```").then(function(){
        llmOut.value = ''; // Clear after copy to encourage generating a new packet
      });
    });

    if (llmClear) llmClear.addEventListener('click', function(){
      if(llmOut) llmOut.value='';
      if(llmIn) llmIn.value='';
    });

    function stripCR(s){ return (s||'').replace(/\r/g,''); }

    var importBtn = $('llm-import');
    if (importBtn) importBtn.addEventListener('click', function(){
      var text = llmIn ? llmIn.value : '';
      if(!text){ append('Paste a packet first.', 'system'); return; }
      text = text.trim();
      if(text.startsWith('```')){
        var firstNL = text.indexOf('\n');
        var lastFence = text.lastIndexOf('```');
        if(firstNL!==-1 && lastFence!==-1){ text = text.slice(firstNL+1, lastFence); }
      }
      var lines = stripCR(text).split('\n');
      var start = lines.indexOf('BEGIN DUELPACK v1');
      var end = lines.lastIndexOf('END DUELPACK');
      if(start===-1 || end===-1 || end<=start+4){ append('Invalid packet format.', 'system'); return; }
      function valOf(line){ var p=line.indexOf('='); return p>=0? line.slice(p+1).trim():''; }
      var room = valOf(lines[start+1]||'');
      var fp = valOf(lines[start+2]||'');
      var seq = Number(valOf(lines[start+3]||''));
      var ciphertext = lines.slice(start+4, end).join('\n').trim();
      if(room !== state.room){ append('Room ID mismatch. Check your ID.', 'system'); return; }
      if((fp||'') !== ((fpLabel && fpLabel.textContent)||'')){ append('Fingerprint mismatch (wrong password).', 'system'); return; }
      
      decryptObj(ciphertext).then(function(pack){
        if(!pack || !pack.items){ append('Decrypt failed (incorrect password or corrupted packet).', 'system'); return; }
        if(state.seenPacks.has(pack.seq)){ append('Duplicate packet ignored', 'system'); return; }
        state.seenPacks.add(pack.seq);
        for(var i=0;i<pack.items.length;i++){ 
            var it=pack.items[i]; 
            if(!state.seen.has(it.id)){ state.seen.add(it.id); handlePayload(it); } 
        }
        append('Imported packet #'+pack.seq+' from '+pack.sender, 'system');
        if(llmIn) llmIn.value='';
      });
    });
  </script>
</body>
</html>
